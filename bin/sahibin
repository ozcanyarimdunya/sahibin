#!/usr/bin/env python3
"""
Sahibin, an online text sharer.
@ozcanyarimdunya
"""
import argparse
import json
import os
import ssl
import sys
from urllib.error import HTTPError
from urllib.error import URLError
from urllib.request import Request
from urllib.request import urlopen

__author__ = "@ozcanyarimdunya"
__version__ = "1.0.8"
SAHIBIN_URL = os.getenv("SAHIBIN_URL", "http://0.0.0.0:8000")


def api(content, expire=1):
    data = {"data": content, "expire": expire}
    payload = json.dumps(data).encode("utf-8")
    headers = {
        "Content-Type": "application/json",
        "Content-Length": len(payload)
    }
    request = Request(
        url=SAHIBIN_URL + "/api",
        data=payload,
        headers=headers,
        method="POST",
    )
    context = ssl.create_default_context()
    context.check_hostname = False
    context.verify_mode = ssl.CERT_NONE
    try:
        with urlopen(request, context=context) as response:
            body = response.read().decode("utf-8")
            key = json.loads(body).get("key")
            return 0, SAHIBIN_URL + "/share/" + key
    except HTTPError as ex:
        return 1, ex
    except URLError as ex:
        return 1, ex
    except Exception as ex:
        return 1, ex


def main():
    parser = argparse.ArgumentParser(description="Sahibin, an online text sharer.", epilog=__author__)
    parser.add_argument(
        "-v",
        "--version",
        action="version",
        version=__version__,
    )
    parser.add_argument(
        "-e",
        dest="expire",
        metavar="<value>",
        help="The paste expire duration in days (default: %(default)s for 1 day, 0 for never expire).",
        type=int,
        default=1,
    )
    if sys.stdin.isatty():
        parser.add_argument("content", help="The paste content", type=str)
        args = vars(parser.parse_args())
    else:
        args = vars(parser.parse_args())
        args.update(content=sys.stdin.read().strip())
    code, result = api(**args)
    print(result)
    return code


if __name__ == '__main__':
    sys.exit(main())
